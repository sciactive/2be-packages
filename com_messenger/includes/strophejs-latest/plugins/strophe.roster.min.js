Strophe.addConnectionPlugin("roster",{_connection:null,_callbacks:[],items:[],ver:null,init:function(conn){this._connection=conn;this.items=[];conn.addHandler(this._onReceivePresence.bind(this),null,"presence",null,null,null);conn.addHandler(this._onReceiveIQ.bind(this),Strophe.NS.ROSTER,"iq","set",null,null);Strophe.addNamespace("ROSTER_VER","urn:xmpp:features:rosterver")},supportVersioning:function(){return(this._connection.features&&this._connection.features.getElementsByTagName("ver").length>0)},get:function(userCallback,ver,items){var attrs={xmlns:Strophe.NS.ROSTER};this.items=[];if(this.supportVersioning()){attrs.ver=ver||"";this.items=items||[]}var iq=$iq({type:"get",id:this._connection.getUniqueId("roster")}).c("query",attrs);this._connection.sendIQ(iq,this._onReceiveRosterSuccess.bind(this,userCallback),this._onReceiveRosterError.bind(this,userCallback))},registerCallback:function(call_back){this._callbacks.push(call_back)},findItem:function(jid){for(var i=0;i<this.items.length;i++){if(this.items[i].jid==jid){return this.items[i]}}return false},subscribe:function(jid){this._connection.send($pres({to:jid,type:"subscribe"}))},unsubscribe:function(jid){this._connection.send($pres({to:jid,type:"unsubscribe"}))},authorize:function(jid){this._connection.send($pres({to:jid,type:"subscribed"}))},unauthorize:function(jid){this._connection.send($pres({to:jid,type:"unsubscribed"}))},update:function(jid,name,groups,call_back){var item=this.findItem(jid);if(!item){throw"item not found"}var newName=name||item.name;var newGroups=groups||item.groups;var iq=$iq({type:"set"}).c("query",{xmlns:Strophe.NS.ROSTER}).c("item",{jid:item.jid,name:newName,subscription:item.subscription});for(var i=0;i<newGroups.length;i++){iq.c("group").t(newGroups[i]).up()}this._connection.sendIQ(iq,call_back,call_back)},_onReceiveRosterSuccess:function(userCallback,stanza){this._updateItems(stanza);userCallback(this.items)},_onReceiveRosterError:function(userCallback,stanza){userCallback(this.items)},_onReceivePresence:function(presence){var jid=presence.getAttribute("from");var from=Strophe.getBareJidFromJid(jid);var item=this.findItem(from);if(!item){return true}var type=presence.getAttribute("type");if(type=="unavailable"){delete item.resources[Strophe.getResourceFromJid(jid)]}else{item.resources[Strophe.getResourceFromJid(jid)]={show:(presence.getElementsByTagName("show").length!=0)?Strophe.getText(presence.getElementsByTagName("show")[0]):"",status:(presence.getElementsByTagName("status").length!=0)?Strophe.getText(presence.getElementsByTagName("status")[0]):"",priority:(presence.getElementsByTagName("priority").length!=0)?Strophe.getText(presence.getElementsByTagName("priority")[0]):""}}this._call_backs(this.items,item);return true},_call_backs:function(items,item){for(var i=0;i<this._callbacks.length;i++){this._callbacks[i](items,item)}},_onReceiveIQ:function(iq){var id=iq.getAttribute("id");var from=iq.getAttribute("from");var iqresult=$iq({type:"result",id:id,to:from});this._connection.send(iqresult);this._updateItems(iq);return true},_updateItems:function(iq){var query=iq.getElementsByTagName("query");if(query.length!=0){this.ver=query.item(0).getAttribute("ver");var self=this;Strophe.forEachChild(query.item(0),"item",function(item){self._updateItem(item)})}this._call_backs(this.items)},_updateItem:function(item){var jid=item.getAttribute("jid");var name=item.getAttribute("name");var subscription=item.getAttribute("subscription");var groups=[];Strophe.forEachChild(item,"group",function(group){groups.push(Strophe.getText(group))});var item=this.findItem(jid);if(!item){this.items.push({name:name,jid:jid,subscription:subscription,groups:groups,resources:{}})}else{item.name=name;item.subscription=subscription;item.group=groups}}});